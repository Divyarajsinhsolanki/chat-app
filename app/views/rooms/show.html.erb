<% if user_signed_in? %>
  <div>hey <%= current_user&.name %></div>
  <h1>Users online</h1>
  <ul id="online-users">
    <%= render partial: "pages/user", collection: User.online, as: :user %>
  </ul>

  <%= form_with(url: rooms_create_url, remote: true, class: "d-flex" ) do |f| %>
    <%= f.text_field :name, class: "form-control",id: "chat_text", autocomplete: 'off' %>
    <%= f.submit data: { disable_with: false } %>
  <% end %>
  <br><div id="rooms">
    <%= render @rooms %>
  </div>
<% end %>

<br><span style="margin: 0 10px">Room-</span><%= @room.name %><br><br>

  <div id="messages">
  <% @messages.each_with_index do |message, index| %>
    <% if message.room.messages[index - 1].user.id == message.user.id && index != -1 %>
      <%= render partial: 'messages/message',locals: { message: message ,sameuser: false} %>
    <% else %>
    <%= render partial: 'messages/message',locals: { message: message, sameuser: true } %>
    <% end %>
  <% end %>
    <%#= render @messages %>
  </div>

<div id="typing-<%=@room.id%>">
  <span style="opacity:0;"><%=current_user.id%></span>
</div>

  <div class="form-group msg-form">
    <%= form_with(url: messages_create_url, class: "d-flex",data: { controller: "reset-form", action: "turbo:submit-end->reset-form#reset" }) do |f| %>
      <%= f.hidden_field :room_id, value: "#{@room.id}" %>
      <%= f.text_field :content, id: 'chat', class: "form-control msg-content", autocomplete: 'off' %>
      <%= f.file_field :photo %>
      <%= f.submit data: { disable_with: false }, class: "btn btn-primary" %>
    <% end %>
  </div>

<script>
$(document).ready(function(){
  var tmo = null;
  $("#chat").on("input", function(){
     $.ajax({
      type: 'GET',
      url: '/rooms/stoptyping',
      data: {"room":"<%= @room.id %>"},
    });
    if (tmo) {
      clearTimeout(tmo);
    }
    tmo = setTimeout(function () {
      $.ajax({
        type: 'GET',
        url: '/rooms/typingstatus',
        data: {"room":"<%= @room.id %>"},
    });
    }, 700);
  });
});
</script>