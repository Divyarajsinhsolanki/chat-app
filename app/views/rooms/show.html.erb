<% if user_signed_in? %>
  <div>hey <%= current_user&.name %></div>
  <h1>Users online</h1>
  <ul id="online-users">
    <%= render partial: "pages/user", collection: User.online, as: :user %>
  </ul>

  <%#= render partial: "pages/users" %>
  <%= form_with(url: rooms_create_url, remote: true, class: "d-flex" ) do |f| %>
    <%= f.text_field :name, class: "form-control",id: "chat_text", autocomplete: 'off' %>
    <%= f.submit data: { disable_with: false } %>
  <% end %>
  <br><div id="rooms">
    <%= render @rooms %>
  </div>


  
<% end %>

<br><span style="margin: 0 10px">Room-</span><%= @room.name %><br><br>

<div id="allmessages">
  <%= render partial: "messages/messages" %>
</div>

  <div class="form-group msg-form">
    <%= form_with(url: messages_create_url, class: "d-flex",data: { controller: "reset-form", action: "turbo:submit-end->reset-form#reset" }) do |f| %>
      <%= f.hidden_field :room_id, value: "#{@room.id}" %>
      <%= f.text_field :content, id: 'chat', class: "form-control msg-content", autocomplete: 'off' %>
      <%= f.file_field :photo %>
      <%= f.submit data: { disable_with: false }, class: "btn btn-primary" %>
    <% end %>
  </div>


  <hr>

<span id="current-user"><%=  current_user.id %></span>
  
<button id="join-button">Join Room</button>
<button id="leave-button">Leave Room</button>
<button onclick="vidOff()" id="onvideo">Off</button>
<button onclick="vidOn()" id="offvideo">On Video</button><br>
<div id="remote-video-container"></div>
<video id="localvideo" autoplay></video><hr/>
<hr>




<script>
let localstream;

      navigator.webkitGetUserMedia(options, function(stream) { 
      localvideo.srcObject = stream;
      localstream = stream;
      localvideo.play();
      }, function(e) { 
          }); 
  function vidOff() {
    console.log("video off")
      //clearInterval(theDrawLoop);
      //ExtensionData.vidStatus = 'off';
      localvideo.pause();
      localvideo.src = "";
      localstream.getTracks()[0].stop();
  }


  function vidOn() {
  if (navigator.mediaDevices.getUserMedia !== null) {
    var options = { 
    video:true, 
    audio:false 
    };  
    navigator.webkitGetUserMedia(options, function(stream) { 
    localvideo.srcObject = stream;
    localstream = stream;
    localvideo.play();
    }, function(e) { 
        }); 
    }
  }

$(document).ready(function(){
  var tmo = null;
  $("#chat").on("input", function(){
     $.ajax({
      type: 'GET',
      url: '/rooms/stoptyping',
      data: {"room":"<%= @room.id %>"},
    });
    if (tmo) {
      clearTimeout(tmo);
    }
    tmo = setTimeout(function () {
      $.ajax({
        type: 'GET',
        url: '/rooms/typingstatus',
        data: {"room":"<%= @room.id %>"},
    });
    }, 700);
  });
});
</script>