<% if user_signed_in? %>
  <div>hey <%= current_user&.name %></div>
  <h1>Users online</h1>
  <ul id="online-users">
    <%= render partial: "pages/user", collection: User.online, as: :user %>
  </ul>
  <%= form_with(url: rooms_create_url, remote: true, class: "d-flex" ) do |f| %>
    <%= f.text_field :name, class: "form-control",id: "chat_text", autocomplete: 'off' %>
    <%= f.submit data: { disable_with: false } %>
  <% end %>
  <br>
  <div id="rooms">
      <%= render @rooms %>
  </div>
<% end %>

<br><span style="margin: 0 10px">Room-</span><%= @room.name %>
<br><br>

<div id="messages-<%=@room.id%>">
  <%= render @messages %>
</div>

<div id="typing-<%=@room.id%>">
<span style="opacity:0;"><%=current_user.id%></span>
</div>
<%= %>
  <div class="form-group msg-form">
    <%= form_with(url: messages_create_url, class: "d-flex",data: { controller: "reset-form", action: "turbo:submit-end->reset-form#reset" }) do |f| %>
      <%= f.hidden_field :room_id, value: "#{@room.id}" %>
      <%= f.text_field :content, id: 'chat', class: "form-control msg-content", autocomplete: 'off' %>
      <%= f.submit data: { disable_with: false }, class: "btn btn-primary" %>
    <% end %>
<%= turbo_stream.replace "form" do %>
<% end %>
  </div>

<script>
$(document).ready(function(){
  var tmo = null;
  $("#chat").on("input", function(){
     $.ajax({
      type: 'GET',
      url: '/rooms/rtm',
      data: {"room":"<%= @room.id %>"},
    });
    if (tmo) {
      clearTimeout(tmo);
    }
    tmo = setTimeout(function () {
      $.ajax({
        type: 'GET',
        url: '/rooms/rmm',
        data: {"room":"<%= @room.id %>"},

    });
    }, 700);
  });
});
</script>